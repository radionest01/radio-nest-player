<script>
  window.onload = function () {
    const params = new URLSearchParams(window.location.search);
    const streamURL = params.get("stream") || "https://ecpro.myradionest.com:1065/stream";
    const metadataURL = params.get("meta") || "https://ecpro.myradionest.com:1065/status-json.xsl";
    const fallbackLogo = "https://i.ibb.co/hFPZYTvM/Fallback-Album-Art.png";

    const audio = document.getElementById("audio");
    audio.src = streamURL;

    const albumArt = document.getElementById("albumArt");
    let lastSong = "";

    function cleanMetadata(str) {
      return str.replace(/\(.*?\)|\[.*?\]|feat\.|ft\./gi, "").trim();
    }

    function fetchCoverArt(artist) {
      const apiKey = "123";
      const url = `https://www.theaudiodb.com/api/v1/json/${apiKey}/search.php?s=${encodeURIComponent(artist)}`;

      fetch(url)
        .then(res => res.json())
        .then(data => {
          const image = data?.artists?.[0]?.strArtistThumb || fallbackLogo;
          albumArt.style.opacity = 0;
          setTimeout(() => {
            albumArt.src = image;
            albumArt.onerror = () => { albumArt.src = fallbackLogo; };
            albumArt.style.opacity = 1;
          }, 500);
        })
        .catch(() => {
          albumArt.src = fallbackLogo;
        });
    }

    function updatePlayer() {
      fetch(metadataURL)
        .then(res => res.json())
        .then(data => {
          const raw = data?.icestats?.source?.title || "";
          if (!raw || raw === lastSong) return;

          lastSong = raw;
          let [artist, title] = raw.split(" - ");
          artist = cleanMetadata(artist || "Radio");
          title = cleanMetadata(title || "Radio");

          if (artist.toLowerCase() === "unknown") artist = "Radio";
          if (title.toLowerCase() === "unknown") title = "Radio";

          document.getElementById("trackTitle").textContent = title;
          document.getElementById("trackArtist").textContent = artist;

          if (artist !== "My Radio" && title !== "Radio") {
            fetchCoverArt(artist);
          } else {
            albumArt.src = fallbackLogo;
          }
        })
        .catch(err => {
          console.error("Metadata fetch failed:", err);
          albumArt.src = fallbackLogo;
        });
    }

    updatePlayer();
    setInterval(updatePlayer, 15000);

    document.getElementById("playPause").addEventListener("click", () => {
      const button = document.getElementById("playPause");
      const badge = document.getElementById("liveBadge");

      if (audio.paused) {
        audio.play().then(() => {
          button.textContent = "⏸";
          button.classList.add("playing");
          badge.style.display = "inline-block";
          badge.classList.add("glow");
        }).catch(err => {
          console.error("Playback failed:", err);
        });
      } else {
        audio.pause();
        button.textContent = "▶";
        button.classList.remove("playing");
        badge.style.display = "none";
      }
    });

    document.getElementById("volume").addEventListener("input", (e) => {
      audio.volume = e.target.value;
    });

    document.querySelector(".theme-toggle").addEventListener("click", () => {
      const player = document.getElementById("radioNestPlayer");
      player.classList.toggle("dark-theme");
      player.classList.toggle("light-theme");
    });
  };
</script>
